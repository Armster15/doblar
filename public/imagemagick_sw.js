(()=>{(function(e){var s=[];function a(t){var o=this;t=String(t);var n="$BroadcastChannel$"+t+"$";s[n]=s[n]||[],s[n].push(this),this._name=t,this._id=n,this._closed=!1,this._mc=new MessageChannel,this._mc.port1.start(),this._mc.port2.start(),e.addEventListener("storage",function(r){if(r.storageArea===e.localStorage&&r.newValue!==null&&r.key.substring(0,n.length)===n){var i=JSON.parse(r.newValue);o._mc.port2.postMessage(i)}})}a.prototype={get name(){return this._name},postMessage:function(t){var o=this;if(this._closed){var n=new Error;throw n.name="InvalidStateError",n}var r=JSON.stringify(t),i=this._id+String(Date.now())+"$"+String(Math.random());e.localStorage.setItem(i,r),setTimeout(function(){e.localStorage.removeItem(i)},500),s[this._id].forEach(function(c){c!==o&&c._mc.port2.postMessage(JSON.parse(r))})},close:function(){if(!this._closed){this._closed=!0,this._mc.port1.close(),this._mc.port2.close();var t=s[this._id].indexOf(this);s[this._id].splice(t,1)}},get onmessage(){return this._mc.port1.onmessage},set onmessage(t){this._mc.port1.onmessage=t},addEventListener:function(t,o){return this._mc.port1.addEventListener.apply(this._mc.port1,arguments)},removeEventListener:function(t,o){return this._mc.port1.removeEventListener.apply(this._mc.port1,arguments)},dispatchEvent:function(t){return this._mc.port1.dispatchEvent.apply(this._mc.port1,arguments)}},e.BroadcastChannel=e.BroadcastChannel||a})(self);var h=new BroadcastChannel("imagemagick-progress"),l=new BroadcastChannel("imagemagick-onready"),d=new BroadcastChannel("imagemagick-loadingmethod");self.addEventListener("activate",function(e){self.skipWaiting(),e.waitUntil(self.clients.claim().then(()=>{l.postMessage(!0)}))});function u(e,s){var a=0;return new Promise((t,o)=>{function n(){e.read().then(({done:r,value:i})=>{if(r){t();return}a+=i.byteLength,h.postMessage({bytesDownloadedTotal:a,bytesJustDownloaded:i?.byteLength,percent:s?a/s*100:void 0}),n()}).catch(o)}n()})}self.addEventListener("fetch",function(e){(/\/assets\/worker.*.js$/.test(e.request.url)||/\/node_modules\/.vite\/imagemagick-wasm-builds.js/.test(e.request.url))&&e.respondWith(caches.match(e.request).then(function(s){return s?(d.postMessage("cache"),console.log("Found ImageMagick in cache:",s),s):(d.postMessage("download"),console.log("ImageMagick not found in cache. About to fetch from network..."),fetch(e.request).then(a=>{let t=a.clone(),o;return o=Number(18991216),u(t.body.getReader(),o).then(()=>(caches.open("imagemagick").then(n=>{n.add(e.request)}),a))}).catch(function(a){throw console.error("Fetching failed:",a),a}))}))});})();
